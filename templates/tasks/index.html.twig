{% extends 'base.html.twig' %}

{% block title %}Tasks List{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('css/dataTable-Bootstarp.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('css/dataTables.bootstrap4.min.css') }}" rel="stylesheet" type="text/css"/>
    <style>
        #tasks-list_filter{
            float: right;
        }
        #tasks-list td, #tasks-list th {
            text-align: center;
            font-size: 20px;
        }
    </style>
{% endblock %}

{% block body %}
    <!-- block -->
    <div class="block">
        <div class="navbar navbar-inner block-header" style="margin-bottom: 30px;">
            <div class="muted pull-left">Tasks List</div>
        </div>
        <div class="table-responsive">
            <table id="tasks-list" class="table table-striped table-head-color dataTable no-footer" width="100%">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Posted By</th>
                        <th>Due Date</th>
                        <th>RP</th>
                        <th>Accepted By</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{task.title}}</td>
                        <td>{{task.description|slice(0, 15) ~ '...'}}</td>
                        <td>{{task.user}}</td>
                        <td class="dueDate">{{task.due_date|date('Y-m-d')}}</td>
                        <td>{{task.respect_points}}</td>
                        <td>{{(task.accepted_by)? task.accepted_by: '-'}}</td>
                        <td>{{task.status}}</td>
                        <td>
                            <a href="#ViewTaskModal" data-toggle="modal" class="view-task btn btn-primary" data-id="{{task.id}}">View</a>
                            {% if task.status == 'Added' %}
                            <a href="#AcceptModal" data-toggle="modal" class="accept-task btn btn-success" data-id="{{task.id}}">Accept</a>
                            {% elseif task.status == 'Accepted' %}
                                {% if app.user.id == task.accepted_by_userId %}
                                <a href="#FinishModal" data-toggle="modal" class="finish-task btn btn-warning" data-id="{{task.id}}">Finish</a>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- /block -->
    <!-- Manage Task Modal -->
    <div id="ViewTaskModal" class="modal hide">
        <div class="modal-header">
            <button data-dismiss="modal" class="close" type="button">&times;</button>
            <h3> Task Details</h3>
        </div>
        <div class="modal-body">
            <fieldset>
                <div class="control-group">
                    <span class="control-label">Task Title:- </span>
                    <span class="control-label title m-wrap"></span>
                </div>
                <div class="control-group">
                    <span class="control-label">Task Description:- </span>
                    <span class="control-label description m-wrap"></span>
                </div>
                <div class="control-group">
                    <span class="control-label">Due Date:- </span>
                    <span class="control-label due_date m-wrap"></span>
                </div>
                <div class="control-group">
                    <span class="control-label">Respect Points:- </span>
                    <span class="control-label respect_points m-wrap"></span>
                </div>
                <div class="control-group">
                    <span class="control-label">Status:- </span>
                    <span class="control-label status m-wrap"></span>
                </div>
                <div class="control-group">
                    <span class="control-label">Accepted By:- </span>
                    <span class="control-label accepted_by m-wrap"></span>
                </div>
            </fieldset>
        </div>
    </div>
    <!-- Delete Task Modal -->
    <div id="AcceptModal" class="modal hide">
        <form action="{{ path('accept-task') }}" id="task-accept-form" method="GET" class="form-horizontal">
            <div class="modal-header">
                <button data-dismiss="modal" class="close" type="button">&times;</button>
                <h3>Confirm</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to accept this task?</p>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Accept</button>
                <button data-dismiss="modal" type="button" class="btn">Cancel</button>
            </div>
        </form>
    </div>
    <!-- Finish Task Modal -->
    <div id="FinishModal" class="modal hide">
        <form action="{{ path('finish-task') }}" id="task-finish-form" method="GET" class="form-horizontal">
            <div class="modal-header">
                <button data-dismiss="modal" class="close" type="button">&times;</button>
                <h3>Confirm</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to finish this task?</p>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-warning">Finish</button>
                <button data-dismiss="modal" type="button" class="btn">Cancel</button>
            </div>
        </form>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('js/dataTables.bootstrap4.min.js') }}"></script>
    <script src="{{ asset('js/dataTables.responsive.min.js') }}"></script>
    <script src="{{ asset('js/jquery.validate.min.js') }}"></script>
    <script type="text/javascript">
        var tasks = JSON.parse('{{tasks|json_encode|raw}}');
        jQuery('#tasks-list').DataTable({
            "aoColumnDefs": [
                {'bSortable': false, 'aTargets': [1,5,6,7]},
            ]
        });
        jQuery(document).ready(function () {            
            
            $('#tasks-list').on('click', '.view-task', function () {
                var uid = $(this).data('id');
                var taskObj = jQuery.grep(tasks, function (task) { return task.id == uid });
                $('span.id').html(taskObj[0]['id']);
                $('span.title').html(taskObj[0]['title']);
                $('span.description').html(taskObj[0]['description']);
                $('span.due_date').html($(this).parents('tr').find('.dueDate').html());
                $('span.respect_points').html(taskObj[0]['respect_points']);
                $('span.status').html(taskObj[0]['status']);
                $('span.accepted_by').html(taskObj[0]['accepted_by']);
            });
            
            $('#tasks-list').on('click', '.accept-task', function () {
                $('#task-accept-form').attr('action', '/accept-task/'+$(this).data('id'));
            });
            
            $('#tasks-list').on('click', '.finish-task', function () {
                $('#task-finish-form').attr('action', '/finish-task/'+$(this).data('id'));
            });
            
        });
    </script>
{% endblock %}