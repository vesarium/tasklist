{% extends 'base.html.twig' %}

{% block title %}Tasks List{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="{{ asset('css/dataTable-Bootstarp.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('css/dataTables.bootstrap4.min.css') }}" rel="stylesheet" type="text/css"/>
    <link href="{{ asset('css/datepicker.css') }}" rel="stylesheet" type="text/css"/>
    <style>
        #tasks-list_filter{
            float: right;
        }
        #tasks-list td, #tasks-list th {
            text-align: center;
            font-size: 20px;
        }
    </style>
{% endblock %}

{% block body %}
    <!-- block -->
    <div class="block">
        <div class="navbar navbar-inner block-header" style="margin-bottom: 30px;">
            <div class="muted pull-left">Tasks List</div>
        </div>
        <div class="block-content collapse in">
            <div class="table-toolbar">
                <div class="btn-group">
                    <a href="#TaskModal" data-toggle="modal" class="btn btn-lg btn-success add-task">Add New <i class="icon-plus icon-white"></i></a>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table id="tasks-list" class="table table-striped table-head-color dataTable no-footer" width="100%">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Description</th>
                        <th>Due Date</th>
                        <th>RP</th>
                        <th>Accepted By</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{task.title}}</td>
                        <td>{{task.description|slice(0, 15) ~ '...'}}</td>
                        <td class="dueDate">{{task.due_date|date('Y-m-d')}}</td>
                        <td>{{task.respect_points}}</td>
                        <td>{{(task.accepted_by)? task.accepted_by: '-'}}</td>
                        <td>{{task.status}}</td>
                        <td>
                            <a href="#TaskModal" data-toggle="modal" class="edit-task btn btn-primary" data-id="{{task.id}}">Edit</a>
                            <a href="#DeleteModal" data-toggle="modal" class="delete-task btn btn-danger" data-id="{{task.id}}">Delete</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <!-- /block -->
    <!-- Manage Task Modal -->
    <div id="TaskModal" class="modal hide">
        <form action="{{ path('manage-task') }}" id="task-form" method="POST" class="form-horizontal">
            <div class="modal-header">
                <button data-dismiss="modal" class="close" type="button">&times;</button>
                <h3>Edit Task</h3>
            </div>
            <div class="modal-body">
                <fieldset>
                    <div class="alert alert-error hide">
                        <button class="close" data-dismiss="alert"></button>
                        You have some form errors. Please check below.
                    </div>
                    <input type="hidden" name="id" value="0">
                    <div class="control-group">
                        <label class="control-label">Task Title<span class="required">*</span></label>
                        <div class="controls">
                            <input type="text" name="title" data-required="1" class="span6 m-wrap"/>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Task Description<span class="required">*</span></label>
                        <div class="controls">
                            <textarea name="description" class="span6 m-wrap"></textarea>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Due Date<span class="required">*</span></label>
                        <div class="controls">
                            <input name="due_date" readonly type="text" placeholder="YYYY-MM-DD" class="span6 m-wrap" data-toggle="datepicker"/>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label">Respect Points<span class="required">*</span></label>
                        <div class="controls">
                            <input name="respect_points" type="number" min="0" class="span6 m-wrap"/>
                        </div>
                    </div>
                </fieldset>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Update</button>
                <button data-dismiss="modal" type="button" class="btn">Cancel</button>
            </div>
        </form>
    </div>
    <!-- Delete Task Modal -->
    <div id="DeleteModal" class="modal hide">
        <form action="{{ path('delete-task') }}" id="task-delete-form" method="GET" class="form-horizontal">
            <div class="modal-header">
                <button data-dismiss="modal" class="close" type="button">&times;</button>
                <h3>Alert</h3>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this record?</p>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-danger">Delete</button>
                <button data-dismiss="modal" type="button" class="btn">Cancel</button>
            </div>
        </form>
    </div>
{% endblock %}
{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('js/datepicker.js') }}"></script>
    <script src="{{ asset('js/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('js/dataTables.bootstrap4.min.js') }}"></script>
    <script src="{{ asset('js/dataTables.responsive.min.js') }}"></script>
    <script src="{{ asset('js/jquery.validate.min.js') }}"></script>
    <script type="text/javascript">
        var tasks = JSON.parse('{{tasks|json_encode|raw}}');
        jQuery('#tasks-list').DataTable({
            "aoColumnDefs": [
                {'bSortable': false, 'aTargets': [1,4,5,6]},
            ]
        });
        var FormValidation = function () {
            var handleValidation1 = function() {
                var form1 = $('#task-form');
                var error1 = $('.alert-error', form1);
                form1.validate({
                    errorElement: 'span', //default input error message container
                    errorClass: 'help-inline', // default input error message class
                    focusInvalid: false, // do not focus the last invalid input
                    ignore: "",
                    rules: {
                        title: {
                            minlength: 3,
                            required: true
                        },
                        description: {
                            minlength: 3,
                            required: true
                        },
                        due_date: {
                            required: true
                        },
                        respect_points: {
                            required: true
                        }
                    },
                    invalidHandler: function (event, validator) { //display error alert on form submit              
                        error1.show();
                        FormValidation.scrollTo(error1, -200);
                    },
                    highlight: function (element) { // hightlight error inputs
                        $(element).closest('.help-inline').removeClass('ok'); // display OK icon
                        $(element).closest('.control-group').removeClass('success').addClass('error'); // set error class to the control group
                    },
                    unhighlight: function (element) { // revert the change done by hightlight
                        $(element).closest('.control-group').removeClass('error'); // set error class to the control group
                    },
                    success: function (label) {
                        label.addClass('valid').addClass('help-inline ok') // mark the current input as valid and display OK icon
                        .closest('.control-group').removeClass('error').addClass('success'); // set success class to the control group
                    },
                    submitHandler: function (form) {
                        error1.hide();
                        form.submit();
                    }
                });
            };

            return {
                //main function to initiate the module
                init: function () {
                    handleValidation1();
                },
                // wrapper function to scroll to an element
                scrollTo: function (el, offeset) {
                    pos = el ? el.offset().top : 0;
                    jQuery('html,body').animate({
                            scrollTop: pos + (offeset ? offeset : 0)
                        }, 'slow');
                }
            };
        }();
        jQuery(document).ready(function () {
            FormValidation.init();
            
            $('.add-task').on('click', function () {
                $('#task-form h3').html('Add Task');
                $('input[name="id"]').val('0');
                $('input[name="title"]').val('');
                $('textarea[name="description"]').html('');
                $('input[name="due_date"]').val('');
                $('input[name="respect_points"]').val('');
                $('button[type="submit"]').html('Add Task');
            });
            
            
            $('#tasks-list').on('click', '.edit-task', function () {
                var uid = $(this).data('id');
                var taskObj = jQuery.grep(tasks, function (task) { return task.id == uid });
                $('#task-form h3').html('Edit Task');
                $('input[name="id"]').val(taskObj[0]['id']);
                $('input[name="title"]').val(taskObj[0]['title']);
                $('textarea[name="description"]').html(taskObj[0]['description']);
                $('input[name="due_date"]').datepicker('setDate', $(this).parents('tr').find('.dueDate').html());
                $('input[name="respect_points"]').val(taskObj[0]['respect_points']);
                $('button[type="submit"]').html('Update Task');
            });
            
            $('#tasks-list').on('click', '.delete-task', function () {
                $('#task-delete-form').attr('action', '/delete-task/'+$(this).data('id'));
            });
            
        });
        
        $(function() {
            $('[data-toggle="datepicker"]').datepicker({
                format: 'YYYY-MM-DD',
                startDate: '-0m',
                autoHide: true,
                zIndex: 2048
            });
        });
    </script>
{% endblock %}
